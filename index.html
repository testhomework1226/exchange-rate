function fetchRatesToSheet() {
  const url = "https://open.er-api.com/v6/latest/USD";  // 匯率 API
  const response = UrlFetchApp.fetch(url);
  const text = response.getContentText();

  Logger.log("📦 API 回傳內容前100字: " + text.substring(0, 100));

  let data;
  try {
    data = JSON.parse(text);
  } catch (e) {
    Logger.log("⚠️ JSON 解析錯誤：" + e);
    return;
  }

  if (!data || !data.rates) {
    Logger.log("⚠️ 找不到 data.rates！");
    return;
  }

  const sheetName = "匯率資料";
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) sheet = ss.insertSheet(sheetName);
  sheet.clear();

  const rates = data.rates;
  const rows = [];

  for (const [currency, rate] of Object.entries(rates)) {
    if (currency && rate) rows.push([currency, rate]);
  }

  if (rows.length === 0) {
    Logger.log("⚠️ 沒有匯率資料可寫入。");
    return;
  }

  // 取得目前時間
  const now = new Date();
  const formattedTime = Utilities.formatDate(now, "Asia/Taipei", "yyyy/MM/dd HH:mm:ss");

  // 寫入標題與資料
  sheet.getRange(1, 1, 1, 2).setValues([["📅 最後更新時間", formattedTime]]);
  sheet.getRange(2, 1, 1, 2).setValues([["基準貨幣", data.base_code]]);
  sheet.getRange(4, 1, 1, 2).setValues([["貨幣代碼", "匯率"]]);
  sheet.getRange(5, 1, rows.length, 2).setValues(rows);

  // 調整欄寬
  sheet.autoResizeColumns(1, 2);

  Logger.log("✅ 匯率資料更新完成，共 " + rows.length + " 筆。");
}
